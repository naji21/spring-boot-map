/*
 Author: naji 
*/

!function(e){"use strict";var t={onSelectItem:function(){},onDrawEnd:function(){},onContextMenu:function(){}};e.naji=e.naji||{},e.naji.MapOverlay={init:function(e){var n,r,o=_.assignIn(t,e),i=e.map,a=!1,u=!!o.viewMode,l=new naji.MapOverlay.Manager(i),s={feature:void 0,event:void 0,coordinate:void 0,drag:!1};i.getInteractions().forEach(function(e){e instanceof ol.interaction.DragPan&&(r=e)},this);var d=new naji.MapOverlay.Overlay(l);d.on("drawend",function(e){r.setActive(!0),"note"===(n=e).type&&n.getTemplate().addClass("selected"),o.onDrawEnd(n)}),d.on("drawstart",function(){r.setActive(!1)});var c=function(){$(this).hasClass("selected")||g($(this))},f=function(e){$(e.target).hasClass("ui-resizable-handle")||g()},v=function(e){u=e,i.removeInteraction(s.event),l.eventActive(!u),$(".mapOverlay-text-wrap.selected").removeClass("selected"),$(".mapOverlay-popover").popover("hide"),n=void 0,u?(r.setActive(!0),$("#"+i.getTarget()).off(".overlay"),g(),s.event=new ol.interaction.Pointer({handleDownEvent:function(e){g();var t=e.map.forEachFeatureAtPixel(e.pixel,function(e){return e});return!(!t||!l.getItem(t.getId()))&&(s.feature=t,!!t)},handleUpEvent:function(e){var t=e.map.forEachFeatureAtPixel(e.pixel,function(e){return e});if(s.feature&&t){var n=l.getItem(s.feature.getId());"marker"===n.type&&g(n.getTemplate())}return s.feature=null,!1}}),i.addInteraction(s.event)):($("#"+i.getTarget()).on("click.overlay",".mapOverlay-text-wrap",function(e){e.stopPropagation(),c.call(this),e.selectedItem=n,o.onSelectItem(e)}).on("contextmenu.overlay",".mapOverlay-text-wrap",function(e){e.preventDefault(),c.call(this),e.selectedItem=n,o.onContextMenu(e)}).on("mousedown.overlay",f).on("resizestart.overlay",function(){r.setActive(!1)}).on("resizeend.overlay",function(){r.setActive(!0)}).on("dragstart.overlay",function(e,t){g(l.getItem(t).getTemplate()),r.setActive(!1)}).on("dragend.overlay",function(){r.setActive(!0),n.setPositionByPixel()}),s.event=new ol.interaction.Pointer({handleDownEvent:function(e){var t=e.map.forEachFeatureAtPixel(e.pixel,function(e){return e});if(s.feature=void 0,s.coordinate=void 0,t){if(l.getItem(t.getId()))return s.feature=t,s.coordinate=e.coordinate,!0}else{if(n&&"note"===n.type&&!n.fixed())return!0;if($(e.originalEvent.target).hasClass("ui-resizable-handle"))return!0}return!1},handleDragEvent:function(e){if(!u&&n&&a)n.setPosition(e.coordinate);else if(s.coordinate){var t=e.coordinate[0]-s.coordinate[0],r=e.coordinate[1]-s.coordinate[1];s.feature.getGeometry().translate(t,r),s.coordinate=e.coordinate,s.drag=!0}},handleUpEvent:function(e){if(s.feature){var t=l.getItem(s.feature.getId());t&&(g(t.getTemplate()),s.drag||(e.selectedItem=n,o.onSelectItem(e)))}return s.drag=!1,!u&&n&&a&&(r.setActive(!0),a=!1),s.coordinate=null,s.feature=null,!1}}),i.addInteraction(s.event))},g=function(e){var t=e?e.attr("id"):"-";if(n&&n.id===t)return!1;$(".mapOverlay-text-wrap.selected").removeClass("selected").resizable("disable"),$(".mapOverlay-popover").popover("hide"),e?"note"===(n=l.getItem(e.attr("id"))).type?e.addClass("selected").resizable("enable"):s.drag||setTimeout(n.showPopover,20):n=void 0};v(u);return{addItem:function(e,t){return n=void 0,!u&&(g(),n=d.addItem(e,t))},viewMode:v,getItemById:function(e){if(e)return l.getItem(e)},getSelectedItem:function(){return n},setDefaultStyle:d.setDefaultStyle,exportItems:function(){var e=l.exportData();return JSON.stringify(e)},importItems:function(e){l.importData(JSON.parse(e),d,u)},getAllItem:function(){return l.getAllItem()}}}}}(window),function(e){"use strict";window.naji.MapOverlay.Manager=function(e){var t=[];return{addItem:function(e){return t.push(e),this},getItem:function(e){return _.filter(t,function(t){return t.id===e})[0]},getLastItem:function(){return t[t.length-1]},removeItem:function(e){return _.remove(t,function(t){return t.id===e}),this},getMap:function(){return e},exportData:function(){return _.map(t,function(e){return e.exportData()})},importData:function(e,t,n){return _.map(e,function(e){t.insertOverlay(e,n)}),this},getAllItem:function(){return t},eventActive:function(e){_.map(t,function(t){e?t.eventOn():t.eventOff()})}}}}(),function(e){"use strict";var t={drawend:function(){},drawstart:function(){}};e.naji.MapOverlay.Overlay=function(e){var n=e.getMap(),r=new naji.MapOverlay.util.Event(n),o={note:new naji.MapOverlay.Note(e),marker:new naji.MapOverlay.Marker(e)},i={event:null,type:null,targetItem:null,handleDownEvent:function(e){if(o[i.type].event.down){t.drawstart();var n=naji.MapOverlay.util.uuid();i.targetItem=o[i.type].event.down(e,n)}return!0},handleDragEvent:function(e){o[i.type].event.drag&&(e.targetItem=i.targetItem,o[i.type].event.drag(e))},handleUpEvent:function(e){r.interaction.off(),o[i.type].event.up&&(e.targetItem=i.targetItem,o[i.type].event.up(e)),t.drawend(i.targetItem)}};return{addItem:function(e,t){o[e].add(t),i.type=e;var r=n.getView().getCenter();return i.handleDownEvent({coordinate:r}),i.handleUpEvent({}),i.targetItem},insertOverlay:function(t,n){t.manager=e;var r=o[t.type].insert(t);e.addItem(r),n||r.eventOn()},on:function(e,n){t[e]&&(t[e]=n)}}}}(window),function(e){"use strict";var t=function(e,t){return['<div id="'+e+'" class="mapOverlay-text-wrap">','   <div class="mapOverlay-text">',"       <div>"+(t||"")+"</div>","   </div>",'   <div class="mapOverlay-text-background"></div>',"</div>"].join("")};e.naji.MapOverlay.Note=function(e){var n,r,o={},i={};return{add:function(e){var t=e||{};n=!!t.fixed,r=!!t.html},insert:function(e){var n,r,o,i=(r=(n=e).id,(o={id:r,$:$(t(r,n.text)),html:n.html,fixed:n.fixed,manager:n.manager,style:n.style,type:"note",title:n.title||""}).$.find(".mapOverlay-text, .mapOverlay-text-background").css(n.size),n.fixed?o.$.css(n.position):o.overlay=new ol.Overlay({position:n.position,element:o.$.get(0),stopEvent:!1}),o);return new naji.MapOverlay.NoteItem(i)},event:{down:function(a,u){var l=e.getMap().getPixelFromCoordinate(a.coordinate);o={x:l[0],y:l[1]};var s=function(e,n){var r=n.id;return n.$=$(t(r)),n.fixed?n.$.css({top:e.y,left:e.x}):n.overlay=new ol.Overlay({position:e,element:n.$.get(0),stopEvent:!1}),n}(n?o:a.coordinate,{id:u,fixed:n,html:r,style:i,manager:e,type:"note"}),d=new naji.MapOverlay.NoteItem(s);return e.addItem(d),d},drag:function(e){e.targetItem.setSize({width:e.originalEvent.offsetX-o.x,height:e.originalEvent.offsetY-o.y})},up:function(e){e.targetItem.eventOn()}}}}}(window),function(e){"use strict";window.naji.MapOverlay.NoteItem=function(e){var t=e.manager,n=t.getMap(),r=e.$,o=e.overlay,i=!!e.html,a=new naji.MapOverlay.NoteStyle(r,e.style||{},i),u=e.id,l=e.fixed,s=e.title||"",d=new naji.MapOverlay.util.Event(n);e.fixed?$("#"+n.getTarget()+" > div").prepend(r):n.addOverlay(e.overlay);var c=function(e){return r.find(".mapOverlay-text, .mapOverlay-text-background").css(e),this},f=function(e){return o.setPosition(e),this},v=function(){d.resize(r,!0,{resize:c}),d.draggable(r,!0)},g=function(){d.resize(r,!1),d.draggable(r,!1)};return{getTemplate:function(){return r},setPosition:f,setPositionByPixel:function(){if(!l){var e=r.position(),t=r.parent().position(),o=n.getCoordinateFromPixel([t.left+e.left,t.top+e.top]);r.css({top:0,left:0}),f(o)}return this},getPosition:function(){return o.getPosition()},setSize:c,style:function(e){return e?(a.setStyle(e),this):a.getStyle()},text:function(e){var t=r.find(" > .mapOverlay-text > div"),n=i?"html":"text";return e?(t[n](e),this):t[n]()},remove:function(){return this.fixed?r.remove():n.removeOverlay(o),t.removeItem(this.id),this},fixed:function(){return l},useHtml:function(e){return e?(i=e,this):i},id:u,exportData:function(){var e=r.find(".mapOverlay-text");return{id:u,title:s,type:"note",style:a.getStyle(),fixed:l,html:i,position:l?r.position():o.getPosition(),size:{width:e.css("width"),height:e.css("height")},text:e.find("> div")[i?"html":"text"]()}},eventOn:v,eventOff:g,moveToMap:function(){if(!l)return!1;g();var e=r.position(),t=n.getCoordinateFromPixel([e.left,e.top]),i=r.clone();i.css({top:0,left:0}),r.remove(),r=i,a.changeText(r),l=!1,o=new ol.Overlay({position:t,element:i.get(0),stopEvent:!1}),n.addOverlay(o),v()},moveToScreen:function(){if(l)return!1;g();var e=$("#"+n.getTarget()).offset(),t=r.offset(),i=r.clone();i.offset({top:t.top-e.top,left:t.left-e.left}),$("#"+n.getTarget()+" > div").prepend(i),n.removeOverlay(o),r=i,a.changeText(r),o=void 0,l=!0,v()},type:"note",resizeDisable:function(){r.resizable("disable")},title:function(e){return e?(s=e,this):s}}}}(),function(e){"use strict";naji.MapOverlay.NoteStyle=function(e,t,n){var r=e,o=n,i=_.assignIn({background:{fill:"#fff",opacity:1,borderColor:"#000",borderWidth:1,borderRadius:0,borderStyle:"solid"},text:{color:"#000",size:"14",align:"left",weight:"400",shadow:"none",stroke:"none"}},t),a=function(e){i=e||i,r.find("> .mapOverlay-text-background").css(function(e){return{"background-color":e.fill,opacity:e.opacity,"border-width":e.borderWidth+"px","border-color":e.borderColor,"border-style":e.borderStyle||"solid","border-radius":e.borderRadius+"px"}}(i.background)),o||(i.text.shadow=i.text.shadow?i.text.shadow:"none",i.text.stroke=i.text.stroke?i.text.stroke:"none",r.find("> .mapOverlay-text > div").removeAttr("style").css(function(e){var t="none";e.shadow&&"none"!==e.shadow&&(t=[(e.shadow.offsetX||0)+"px",(e.shadow.offsetY||0)+"px",(e.shadow.blur||0)+"px",e.shadow.color||"#fff"].join(" "));var n={color:e.color,"font-size":e.size,"font-weight":e.weight,"text-align":e.align,"text-shadow":t};if(e.stroke&&"none"!==e.stroke){var r=[e.stroke.width+"px",e.stroke.color].join(" ");n["-webkit-text-stroke"]=r,n["text-stroke"]=r}return n}(i.text)))};return a(),{getStyle:function(){return i},setStyle:function(e){var t=_.assignIn(i,e);a(t)},changeText:function(e){r=e}}}}(window),function(e){"use strict";var t=function(e,t){return'<div id="'+e+'" class="mapOverlay-popover"></div>'};e.naji.MapOverlay.Marker=function(e){var n,r=e.getMap(),o=function(){(n=new ol.layer.Vector({source:new ol.source.Vector})).setMap(r)};return{add:function(){n||o()},insert:function(e){var r,i,a,u,l=(i=(r=e).id,a=$(t(i)),(u=new ol.Feature({geometry:new ol.geom.Point(r.position),name:"mapMarker"})).setId(i),{id:i,$popover:a,overlay:new ol.Overlay({element:a.get(0),positioning:"bottom-center",stopEvent:!1,offset:[0,-50]}),feature:u,type:"marker",manager:r.manager,content:r.text,featureImageSrc:r.featureImageSrc,title:r.title});n||o(),l.layer=n;var s=new naji.MapOverlay.MarkerItem(l);return s.text(e.text),s},event:{down:function(r,o){var i=function(e,n){var r=n.id;return n.$popover=$(t(r)),n.overlay=new ol.Overlay({element:n.$popover.get(0),positioning:"bottom-center",stopEvent:!1,offset:[0,-50]}),n.feature=new ol.Feature({geometry:new ol.geom.Point(e),name:"mapMarker"}),n.feature.setId(r),n}(r.coordinate,{id:o,type:"marker",manager:e,layer:n}),a=new naji.MapOverlay.MarkerItem(i);return e.addItem(a),a},up:function(e){e.targetItem.eventOn()}}}}}(window),function(e){"use strict";window.naji.MapOverlay.MarkerItem=function(e){var t=e.manager,n=t.getMap(),r=e.id,o=e.feature,i=e.layer,a=e.$popover,u=e.overlay,l=e.content||"",s=new naji.MapOverlay.MarkerStyle({feature:o,featureImageSrc:e.featureImageSrc}),d=e.title||"";new naji.MapOverlay.util.Event(n);i.getSource().addFeature(o),n.addOverlay(u);var c=this;return{remove:function(){i.getSource().removeFeature(o),n.removeOverlay(u),t.removeItem(r)},getTemplate:function(){return a},text:function(e){return e?(l=e,a.data("bs.popover")&&a.popover("destroy"),t=a.clone(),a.remove(),a=t,u.setElement(a.get(0)),a.popover({placement:"top",html:!0,content:l}).on("inserted.bs.popover",function(e){a.next().css(s.size())}),c):l;var t},setPosition:function(e){return o.setGeometry(new ol.geom.Point(e)),c},eventOn:function(){},eventOff:function(){},type:"marker",id:r,showPopover:function(){var e=o.getGeometry().getCoordinates();u.setPosition(e),a.popover("toggle")},hidePopover:function(){a.popover("hide")},exportData:function(){return{id:r,title:d,text:l,type:"marker",featureImageSrc:s.markerImage(),position:o.getGeometry().getCoordinates()}},changeMarkerImage:function(e){s.markerImage(e)},setSize:function(e){if(!e)return!1;s.size(e)},getSize:s.size,title:function(e){return e?(d=e,this):d}}}}(),function(e){var t=function(e){var t=$.Deferred();return function(e){var t=$.Deferred(),n=new Image;return n.onload=function(){t.resolve(n)},n.src=e,t}(e).then(function(e){var n;t.resolve((n=e,new ol.style.Style({image:new ol.style.Icon({anchor:[.5,n.height-2],anchorXUnits:"fraction",anchorYUnits:"pixels",img:n,imgSize:[n.width,n.height]})})))},t.reject),t};naji.MapOverlay.MarkerStyle=function(e){var n={},r=e.featureImageSrc||"data:image/png;base64,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",o=function(n){if(!n)return r;t(r=n).done(function(t){e.feature.setStyle(t)})};return o(r),{markerImage:o,size:function(e){return e?(n=_.assignIn(n,e),this):{width:n.width,height:n.height}}}}}(window),function(e){"use strict";e.naji.MapOverlay.util=e.naji.MapOverlay.util||{},e.naji.MapOverlay.util.Event=function(e){var t={event:null,on:function(n){t.event=new ol.interaction.Pointer(n),e.addInteraction(t.event)},off:function(){e.removeInteraction(t.event)}};return{interaction:t,draggable:function(t,n,r){if(!n)return t.draggable("destroy"),!1;t.draggable({start:function(){document.body.style.cursor="move",$("#"+e.getTarget()).trigger("dragstart",[t.attr("id")])},stop:function(){$("#"+e.getTarget()).trigger("dragend")}})},resize:function(t,n,r){if(!n)return t.resizable("destroy"),!1;t.resizable({start:function(){$("#"+e.getTarget()).trigger("resizestart")},resize:function(){var e=$(this);r.resize({width:e.width(),height:e.height()})},stop:function(){$("#"+e.getTarget()).trigger("resizeend")}})}}},e.naji.MapOverlay.util.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}}(window);
//# sourceMappingURL=mapOverlay.min.js.map